<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gizli Sohbet Odasý (Sesli)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Kaydýrma çubuðu stilleri */
        #messages-box::-webkit-scrollbar {
            width: 8px;
        }
        #messages-box::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        #messages-box::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        #messages-box::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4">
        <!-- Giriþ ve Oda Seçim Ekraný -->
        <div id="room-selection" class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl">
            <h1 class="text-3xl font-bold mb-2">Gizli Sohbet</h1>
            <p class="text-gray-400 mb-8">Yeni bir sohbet odasý oluþturun veya mevcut bir odaya katýlýn.</p>
            
            <div class="space-y-4">
                <button id="createRoomBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Yeni Oda Oluþtur
                </button>
                
                <div class="flex items-center space-x-2">
                    <input type="text" id="roomCodeInput" placeholder="Oda Kodunu Girin" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="joinRoomBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        Katýl
                    </button>
                </div>
            </div>
             <p id="auth-status" class="text-xs text-gray-500 mt-4">Kimlik doðrulama bekleniyor...</p>
        </div>

        <!-- Sohbet Ekraný (Baþlangýçta gizli) -->
        <div id="chat-container" class="hidden h-[85vh] flex flex-col bg-gray-800 p-4 sm:p-6 rounded-lg shadow-2xl">
            <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
                <div class="flex justify-between items-center">
                     <h2 class="text-xl font-semibold">Sohbet Odasý</h2>
                     <button id="leaveRoomBtn" class="text-sm text-red-400 hover:text-red-500 transition duration-300">Odayý Terk Et</button>
                </div>
                <p class="text-sm text-indigo-400 mt-1">Oda Kodu: 
                    <strong id="room-code-display" class="select-all cursor-pointer bg-gray-700 px-2 py-1 rounded"></strong>
                </p>
                <!-- Sesli Sohbet Kontrol Paneli -->
                <div id="call-controls" class="mt-4 p-3 bg-gray-700/50 rounded-lg flex items-center justify-between">
                    <p id="call-status" class="text-sm text-gray-400">Sesli sohbete hazýr.</p>
                    <div>
                        <button id="startCallBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Çaðrý Baþlat</button>
                        <button id="endCallBtn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Çaðrýyý Bitir</button>
                    </div>
                </div>
            </div>
            
            <!-- Mesajlarýn Gösterileceði Alan -->
            <div id="messages-box" class="flex-grow overflow-y-auto mb-4 space-y-4 pr-2">
                <!-- Mesajlar buraya dinamik olarak eklenecek -->
            </div>

            <!-- Mesaj Gönderme Formu -->
            <div class="flex-shrink-0 flex space-x-2">
                <input type="text" id="message-input" placeholder="Mesajýnýzý yazýn..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="send-message-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    Gönder
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ses elementleri -->
    <audio id="localAudio" muted></audio>
    <audio id="remoteAudio" autoplay></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase ve Firestore modüllerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- DEÐÝÞKENLER VE DOM ELEMENTLERÝ ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-secure-chat';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elementleri
        const roomSelectionDiv = document.getElementById('room-selection');
        const chatContainerDiv = document.getElementById('chat-container');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const messagesBox = document.getElementById('messages-box');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const authStatus = document.getElementById('auth-status');
        const startCallBtn = document.getElementById('startCallBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callStatus = document.getElementById('call-status');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        
        let db, auth;
        let currentUserId = null;
        let currentRoomCode = null;
        let unsubscribeMessages = null;
        let unsubscribeCallSignal = null;

        // --- WEBRTC DEÐÝÞKENLERÝ ---
        let peerConnection;
        let localStream;
        let remoteStream;
        const configuration = {
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // --- FIREBASE KURULUMU VE KÝMLÝK DOÐRULAMA ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authStatus.textContent = `Kimlik doðrulandý. ID: ${currentUserId.substring(0, 8)}...`;
                    authStatus.classList.replace('text-gray-500', 'text-green-500');
                } else {
                    authStatus.textContent = 'Kimlik doðrulanýyor...';
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Kimlik doðrulama hatasý:", error);
                        authStatus.textContent = "Kimlik doðrulama baþarýsýz oldu.";
                        authStatus.classList.replace('text-gray-500', 'text-red-500');
                    }
                }
            });
        } catch (error) {
            console.error("Firebase baþlatma hatasý:", error);
            document.body.innerHTML = '<div class="text-red-500 text-center p-8">Uygulama baþlatýlamadý.</div>';
        }

        // --- ODA YÖNETÝMÝ ---
        const createRoom = () => {
            if (!currentUserId) {
                callStatus.textContent = "Kimlik doðrulanmadý.";
                return;
            }
            const roomCode = crypto.randomUUID().substring(0, 6).toUpperCase();
            joinRoom(roomCode);
        };
        
        const joinRoom = (roomCode) => {
            if (!roomCode) {
                callStatus.textContent = "Geçerli bir oda kodu girin.";
                return;
            }
            currentRoomCode = roomCode.trim().toUpperCase();
            roomCodeDisplay.textContent = currentRoomCode;

            roomSelectionDiv.classList.add('hidden');
            chatContainerDiv.classList.remove('hidden');
            chatContainerDiv.classList.add('flex');
            
            listenForMessages();
            listenForCallSignals(); // Odaya girince çaðrý sinyallerini dinlemeye baþla
        };

        const leaveRoom = async () => {
            await endCall(); // Odadan ayrýlmadan önce çaðrýyý sonlandýr
            
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeCallSignal) unsubscribeCallSignal();
            
            currentRoomCode = null;
            messagesBox.innerHTML = '';
            
            chatContainerDiv.classList.add('hidden');
            chatContainerDiv.classList.remove('flex');
            roomSelectionDiv.classList.remove('hidden');
        };

        // --- MESAJLAÞMA FONKSÝYONLARI ---
        const listenForMessages = () => {
            if (!currentRoomCode) return;
            if (unsubscribeMessages) unsubscribeMessages();
            const path = `artifacts/${appId}/public/data/secure_chat_rooms/${currentRoomCode}/messages`;
            const q = query(collection(db, path), orderBy("timestamp"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesBox.innerHTML = '';
                snapshot.forEach(doc => displayMessage(doc.data()));
                messagesBox.scrollTop = messagesBox.scrollHeight;
            });
        };

        const displayMessage = (data) => {
            const isMe = data.senderId === currentUserId;
            const wrapper = document.createElement('div');
            wrapper.classList.add('flex', 'w-full', isMe ? 'justify-end' : 'justify-start');
            const bubble = document.createElement('div');
            bubble.classList.add('max-w-xs', 'sm:max-w-md', 'p-3', 'rounded-lg', 'shadow', isMe ? 'bg-indigo-600' : 'bg-gray-600', isMe ? 'rounded-br-none' : 'rounded-bl-none');
            const text = document.createElement('p');
            text.textContent = data.text;
            text.classList.add('text-sm');
            bubble.appendChild(text);
            wrapper.appendChild(bubble);
            messagesBox.appendChild(wrapper);
        };
        
        const sendMessage = async () => {
            const text = messageInput.value.trim();
            if (text && currentRoomCode && currentUserId) {
                const path = `artifacts/${appId}/public/data/secure_chat_rooms/${currentRoomCode}/messages`;
                try {
                    await addDoc(collection(db, path), {
                        text: text,
                        senderId: currentUserId,
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Mesaj gönderme hatasý: ", error);
                }
            }
        };

        // --- SESLÝ SOHBET (WEBRTC) FONKSÝYONLARI ---

        const startCall = async () => {
            startCallBtn.disabled = true;
            callStatus.textContent = "Mikrofon izni isteniyor...";

            try {
                // Mikrofon ve kamera eriþimi al (sadece ses kullanacaðýz)
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                localAudio.srcObject = localStream;
            } catch (error) {
                console.error("getUserMedia error: ", error);
                callStatus.textContent = "Mikrofon eriþimi reddedildi.";
                startCallBtn.disabled = false;
                return;
            }
            
            callStatus.textContent = "Baðlantý kuruluyor...";
            startCallBtn.classList.add('hidden');
            endCallBtn.classList.remove('hidden');

            // RTCPeerConnection oluþtur
            peerConnection = new RTCPeerConnection(configuration);

            // Yerel stream'i peer connection'a ekle
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Uzak stream geldiðinde çalýþacak olan event
            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                remoteAudio.srcObject = remoteStream;
                callStatus.textContent = "Baðlantý kuruldu. Konuþuyorsunuz.";
            };
            
            // ICE candidate'leri Firestore'a gönder
            const callDocRef = doc(db, `artifacts/${appId}/public/data/secure_chat_rooms/${currentRoomCode}/call_signal/main`);
            const offerCandidates = collection(callDocRef, 'offerCandidates');
            const answerCandidates = collection(callDocRef, 'answerCandidates');

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    addDoc(offerCandidates, event.candidate.toJSON());
                }
            };

            // Çaðrý teklifi (offer) oluþtur ve Firestore'a yaz
            const offerDescription = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offerDescription);
            const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
            await setDoc(callDocRef, { offer });

            // Cevap (answer) geldiðinde dinle
            onSnapshot(callDocRef, (snapshot) => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    peerConnection.setRemoteDescription(answerDescription);
                }
            });

            // Answer'dan gelen ICE candidate'leri dinle
            onSnapshot(answerCandidates, snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });
        };

        const endCall = async () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            peerConnection = null;
            localStream = null;
            remoteStream = null;
            localAudio.srcObject = null;
            remoteAudio.srcObject = null;

            startCallBtn.classList.remove('hidden');
            endCallBtn.classList.add('hidden');
            startCallBtn.disabled = false;
            callStatus.textContent = "Çaðrý sonlandýrýldý.";

            // Firestore'daki sinyal verilerini temizle
            if(currentRoomCode) {
                 const callDocRef = doc(db, `artifacts/${appId}/public/data/secure_chat_rooms/${currentRoomCode}/call_signal/main`);
                 const callDocSnap = await getDoc(callDocRef);
                 if (callDocSnap.exists()) {
                    await deleteDoc(callDocRef);
                 }
            }
        };

        // Gelen çaðrý sinyallerini dinle (diðer kullanýcý çaðrý baþlattýðýnda)
        const listenForCallSignals = () => {
            if (!currentRoomCode) return;
            if(unsubscribeCallSignal) unsubscribeCallSignal();

            const callDocRef = doc(db, `artifacts/${appId}/public/data/secure_chat_rooms/${currentRoomCode}/call_signal/main`);
            unsubscribeCallSignal = onSnapshot(callDocRef, async (snapshot) => {
                const data = snapshot.data();
                // Eðer bir offer varsa ve biz çaðrýyý baþlatan deðilsek, cevap ver
                if (data?.offer && !peerConnection) {
                    callStatus.textContent = "Gelen çaðrý var...";
                    startCallBtn.classList.add('hidden');
                    endCallBtn.classList.remove('hidden');
                    
                    peerConnection = new RTCPeerConnection(configuration);

                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                        localAudio.srcObject = localStream;
                        localStream.getTracks().forEach(track => {
                            peerConnection.addTrack(track, localStream);
                        });
                    } catch(e){
                         console.error("Error getting user media on answer", e);
                         callStatus.textContent = "Mikrofon hatasý.";
                         return;
                    }


                    peerConnection.ontrack = event => {
                        remoteStream = event.streams[0];
                        remoteAudio.srcObject = remoteStream;
                        callStatus.textContent = "Baðlantý kuruldu. Konuþuyorsunuz.";
                    };
                    
                    const offerCandidates = collection(callDocRef, 'offerCandidates');
                    const answerCandidates = collection(callDocRef, 'answerCandidates');

                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            addDoc(answerCandidates, event.candidate.toJSON());
                        }
                    };

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answerDescription = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answerDescription);

                    const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
                    await setDoc(callDocRef, { answer }, { merge: true });

                    onSnapshot(offerCandidates, snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                            }
                        });
                    });
                }
            });
        };

        // --- EVENT LISTENERS ---
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', () => joinRoom(roomCodeInput.value));
        leaveRoomBtn.addEventListener('click', leaveRoom);
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        startCallBtn.addEventListener('click', startCall);
        endCallBtn.addEventListener('click', endCall);
    </script>
</body>
</html>
